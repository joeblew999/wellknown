# Discovered PocketBase Development Flow

This document describes the **actual working flow** discovered by implementing the banking example.

## TL;DR - Correct Flow

```bash
# 1. Create migration
# Edit: pb/cmd/pb_migrations/TIMESTAMP_name.go

# 2. Generate models from existing templates
cd pb
make gen-models

# 3. Build and run
go build -o ../bin/wellknown-pb ./cmd
../bin/wellknown-pb serve  # Migrations auto-apply

# 4. (Optional) If you added NEW collections:
make gen-template  # Regenerate templates from pb_data
make gen-models    # Regenerate models from new templates
```

## Key Discoveries

### 1. Models Don't Need pb_data to Generate

**Wrong assumption** (from README):
- Must run server first to create pb_data
- Then generate templates from pb_data
- Then generate models

**Reality**:
- **Templates** (`codegen/_templates/*.go`) can exist independently
- `make gen-models` works as long as templates exist
- Only need `make gen-template` when adding NEW collections

### 2. Migration Timestamps Matter

Migrations MUST have timestamps after the last applied migration:
```
1730709600_init_google_tokens.go  (already applied)
1730710000_init_banking.go         (new - will auto-apply)
```

### 3. Migrations Auto-Apply on Startup

**No manual migration command needed!**
- Just run the server
- Migrations check `_migrations` table
- New migrations automatically apply

### 4. The Correct Development Loop

#### Adding a New Feature (e.g., Banking)

**Step 1**: Create migration
```go
// pb/cmd/pb_migrations/1730710000_init_banking.go
package pb_migrations

import "github.com/pocketbase/pocketbase/core"

func init() {
    core.AppMigrations.Register(
        func(txApp core.App) error {
            accounts := core.NewBaseCollection("accounts")
            accounts.Fields.Add(
                &core.TextField{Name: "user_id", Required: true},
                &core.NumberField{Name: "balance", Required: true},
                // ...
            )
            return txApp.Save(accounts)
        },
        func(txApp core.App) error {
            // Rollback logic
            accounts, _ := txApp.FindCollectionByNameOrId("accounts")
            return txApp.Delete(accounts)
        },
    )
}
```

**Step 2**: Generate models (if templates exist)
```bash
cd pb
make gen-models
```

This creates:
- `codegen/models/proxies.go` - Type-safe wrappers
- `codegen/models/utils.go` - Helper functions
- `codegen/models/proxy_hooks.go` - Event hooks

**Step 3**: Create API handlers
```go
// pb/banking.go
package wellknown

func registerBankingRoutes(wk *Wellknown, e *core.ServeEvent) error {
    e.Router.GET("/api/banking/accounts", handleListAccounts(wk))
    e.Router.POST("/api/banking/accounts", handleCreateAccount(wk))
    return nil
}
```

**Step 4**: Register routes
```go
// pb/wellknown.go
func (wk *Wellknown) OnServe() hook.Handler[*core.ServeEvent] {
    return func(e *core.ServeEvent) error {
        // ...existing routes...

        if err := registerBankingRoutes(wk, e); err != nil {
            return err
        }

        return e.Next()
    }
}
```

**Step 5**: Build and test
```bash
go build -o ../.bin/wellknown-pb ./cmd
../.bin/wellknown-pb serve
```

Server logs show:
```
✅ Google OAuth routes registered (server-based)
✅ Calendar API routes registered (OAuth + Calendar API only)
✅ Banking API routes registered
```

**Step 6**: (Only if you added NEW collections) Update templates
```bash
# After server creates new tables:
make gen-template  # Extracts schema from pb_data
make gen-models    # Regenerates models with new collections
```

## Common Issues Encountered

### Issue 1: "no required module provides package .../pb/codegen/models"

**Cause**: Models haven't been generated yet
**Solution**: Run `make gen-models`

### Issue 2: Migrations not applying

**Cause**: Database already exists with old migrations
**Options**:
1. Delete `pb_data` to start fresh (development only!)
2. Create new migration with newer timestamp

### Issue 3: Air/hot-reload not picking up changes

**Cause**: Build cache or module cache is stale
**Solution**:
```bash
rm -rf pb/tmp
go mod tidy
# Kill and restart Air
```

## File Structure

```
pb/
├── cmd/
│   ├── main.go                    # Entry point
│   ├── pb_migrations/             # Schema definitions (source of truth)
│   │   ├── 1730709600_init_google_tokens.go
│   │   └── 1730710000_init_banking.go
│   └── pb_data/                   # Generated by server (gitignored)
│       └── data.db
├── codegen/
│   ├── _templates/                # Intermediate schema-as-code
│   │   └── google_tokens.go       # Editable template
│   └── models/                    # Generated type-safe code
│       ├── stub.go                # Placeholder (checked in)
│       ├── proxies.go             # Generated (gitignored)
│       ├── utils.go               # Generated (gitignored)
│       └── proxy_hooks.go         # Generated (gitignored)
├── banking.go                     # Banking API handlers
├── calendar.go                    # Calendar API handlers
├── oauth.go                       # OAuth handlers
├── wellknown.go                   # Main app + route registration
├── go.mod
├── Makefile
└── README.md
```

## What Gets Checked Into Git

**DO commit**:
- `cmd/pb_migrations/*.go` - Schema source of truth
- `codegen/_templates/*.go` - Editable templates
- `codegen/models/stub.go` - Package placeholder
- `*.go` (handlers, routes, business logic)
- `Makefile`, `README.md`, docs

**DON'T commit** (in .gitignore):
- `cmd/pb_data/` - Generated database
- `codegen/models/*.go` (except stub.go) - Generated code
- `tmp/`, `build-errors.log` - Build artifacts

## Makefile Targets

```bash
make help           # Show all commands
make gen-template   # Extract schema from pb_data → _templates/*.go
make gen-models     # Generate code from _templates/*.go → models/*.go
make server         # Run server (auto-applies migrations)
make dev            # Run with Air hot-reload
make build          # Build binary
make clean          # Clean generated files
```

## Updated README Required

The current README incorrectly states the flow as:
1. Run server (creates pb_data)
2. Generate template from pb_data
3. Generate models from template

**Should be**:
1. **Create migration** (source of truth)
2. **Generate models** (if templates exist)
3. **Build and run** (auto-applies migrations)
4. **(Optional) Regenerate templates** if new collections added

## Testing the Banking Example

```bash
# 1. Ensure models are generated
cd pb
make gen-models

# 2. Build server
go build -o ../.bin/wellknown-pb ./cmd

# 3. Run server (migrations auto-apply)
../.bin/wellknown-pb serve

# 4. Test endpoints
curl http://localhost:8090/api/health
curl http://localhost:8090/api/banking/accounts?user_id=test

# 5. Check collections via Admin UI
open http://localhost:8090/_/
```

## Next Steps

- [ ] Update `pb/README.md` with correct flow
- [ ] Add `kill-port` target to Makefile
- [ ] Create banking GUI
- [ ] Add integration tests
- [ ] Document Air configuration
