.PHONY: help debug server dev build clean release update version gen-template gen-models

# Paths relative to this Makefile (pb/)
MAKEFILE_DIR := $(patsubst %/,%,$(dir $(abspath $(lastword $(MAKEFILE_LIST)))))
PROJECT_ROOT := $(abspath $(MAKEFILE_DIR)/..)

# Directories
BASE_DIR := $(MAKEFILE_DIR)/cmd
MIGRATIONS_DIR := $(BASE_DIR)/pb_migrations
CODEGEN_DIR := $(MAKEFILE_DIR)/codegen
BIN_DIR := $(PROJECT_ROOT)/.bin
DIST_DIR := $(PROJECT_ROOT)/.dist

# Files
BINARY := $(BIN_DIR)/wellknown-pb
DATA := $(BASE_DIR)/pb_data
MIGRATIONS := $(MIGRATIONS_DIR)
TEMPLATE := $(CODEGEN_DIR)/_templates/google_tokens.go
MODELS := $(CODEGEN_DIR)/models

# GitHub
GH_OWNER := joeblew999
GH_REPO := wellknown

## help: Show available make targets
help:
	@echo "Pocketbase Server:"
	@echo ""
	@grep -E '^##' $(MAKEFILE_LIST) | sed 's/^## /  make /' | column -t -s ':'

.DEFAULT_GOAL := help

## debug: Show all Makefile variables and paths
debug:
	@echo "=== Makefile Debug Info ==="
	@echo ""
	@echo "üìÅ Paths:"
	@echo "  MAKEFILE_DIR  = $(MAKEFILE_DIR)"
	@echo "  PROJECT_ROOT  = $(PROJECT_ROOT)"
	@echo ""
	@echo "üìÇ Directories:"
	@echo "  BASE_DIR        = $(BASE_DIR)"
	@echo "  MIGRATIONS_DIR  = $(MIGRATIONS_DIR)"
	@echo "  CODEGEN_DIR     = $(CODEGEN_DIR)"
	@echo "  BIN_DIR         = $(BIN_DIR)"
	@echo "  DIST_DIR        = $(DIST_DIR)"
	@echo ""
	@echo "üìÑ Files:"
	@echo "  BINARY        = $(BINARY)"
	@echo "  DATA          = $(DATA)"
	@echo "  MIGRATIONS    = $(MIGRATIONS)"
	@echo "  TEMPLATE      = $(TEMPLATE)"
	@echo "  MODELS        = $(MODELS)"
	@echo ""
	@echo "üêô GitHub:"
	@echo "  GH_OWNER      = $(GH_OWNER)"
	@echo "  GH_REPO       = $(GH_REPO)"
	@echo ""
	@echo "‚úÖ File Checks:"
	@if [ -d "$(BASE_DIR)" ]; then echo "  ‚úì BASE_DIR exists"; else echo "  ‚úó BASE_DIR missing"; fi
	@if [ -d "$(MIGRATIONS_DIR)" ]; then echo "  ‚úì MIGRATIONS_DIR exists"; else echo "  ‚úó MIGRATIONS_DIR missing"; fi
	@if [ -d "$(CODEGEN_DIR)" ]; then echo "  ‚úì CODEGEN_DIR exists"; else echo "  ‚úó CODEGEN_DIR missing"; fi
	@if [ -d "$(BIN_DIR)" ]; then echo "  ‚úì BIN_DIR exists"; else echo "  ‚úó BIN_DIR missing"; fi
	@if [ -f "$(BINARY)" ]; then echo "  ‚úì BINARY exists"; else echo "  ‚úó BINARY missing (run 'make build')"; fi
	@if [ -d "$(MODELS)" ]; then echo "  ‚úì MODELS dir exists"; else echo "  ‚úó MODELS dir missing"; fi

## gen-template: Generate template from schema (edit before gen-models)
gen-template:
	@echo "üìù [Step 1/4] Generating template from PocketBase data..."
	@if [ ! -d "$(DATA)" ]; then \
		echo "‚ùå $(DATA) not found!"; \
		echo "   Run 'make server' once to initialize PocketBase"; \
		exit 1; \
	fi
	@mkdir -p $(dir $(TEMPLATE))
	pocketbase-gogen template $(DATA) $(TEMPLATE) --package models
	@echo "‚úÖ Template: $(TEMPLATE)"
	@echo "   [Step 2/4] Edit template, then run: make gen-models"

## gen-models: Generate type-safe models from template
gen-models:
	@echo "üîß [Step 3/4] Generating type-safe models from template..."
	@if [ ! -f "$(TEMPLATE)" ]; then \
		echo "‚ùå Template not found. Run: make gen-template"; \
		exit 1; \
	fi
	pocketbase-gogen generate $(TEMPLATE) $(MODELS)/proxies.go --package models --utils --hooks
	@echo "‚úÖ Models: $(MODELS)/{proxies,utils,proxy_hooks}.go"

## kill-port: Kill any process using port 8090
kill-port:
	@echo "üî´ Killing processes on port 8090..."
	@lsof -ti:8090 | xargs kill -9 2>/dev/null || echo "   No processes found on port 8090"
	@echo "‚úÖ Port 8090 freed"

## server: Run Pocketbase server (auto-creates collections)
server:
	@echo "üöÄ Starting PocketBase server..."
	@echo "Admin UI: http://localhost:8090/_/"
	@if [ -f $(BASE_DIR)/.env ]; then \
		cd $(BASE_DIR) && source .env && go run . serve; \
	else \
		echo "‚ö†Ô∏è  No .env - OAuth disabled. Copy $(BASE_DIR)/.env.example"; \
		cd $(BASE_DIR) && go run . serve; \
	fi

## dev: Run Pocketbase with hot-reload (Air)
dev:
	@echo "üî• Starting PocketBase with hot-reload (Air)..."
	@which air > /dev/null || (echo "‚ùå Air not installed. Run: make install-tools" && exit 1)
	@echo "Admin UI: http://localhost:8090/_/"
	@if [ -f $(BASE_DIR)/.env ]; then \
		echo "‚úÖ Using .env for OAuth"; \
	else \
		echo "‚ö†Ô∏è  No .env - OAuth disabled. Copy $(BASE_DIR)/.env.example"; \
	fi
	air

## build: Build Pocketbase server binary
build:
	@echo "üèóÔ∏è  Building PocketBase server..."
	@mkdir -p $(BIN_DIR)
	cd $(BASE_DIR) && go build -o $(BINARY) .
	@echo "‚úÖ Binary: $(BINARY)"

## clean: Clean generated models and temp files
clean:
	@echo "üßπ Cleaning PocketBase generated files..."
	rm -rf $(MAKEFILE_DIR)/tmp $(MAKEFILE_DIR)/build-errors.log
	rm -f $(MODELS)/*.go
	@echo "‚úÖ Cleaned: tmp/, codegen/models/*.go, build-errors.log"
	@echo "üí° Tip: Run 'make gen-models' to regenerate type-safe models"

## release: Build & create GitHub release (multi-platform)
release:
	@echo "üöÄ Creating GitHub release for PocketBase server..."
	@if ! command -v gh >/dev/null 2>&1; then \
		echo "‚öôÔ∏è  Installing GitHub CLI..."; \
		go install github.com/cli/cli/v2/cmd/gh@latest; \
		if ! command -v gh >/dev/null 2>&1; then \
			echo "‚ùå GitHub CLI install failed or not in PATH"; \
			echo "   Ensure ~/go/bin is in your PATH"; \
			exit 1; \
		fi; \
		echo "‚úÖ GitHub CLI installed"; \
	fi
	@if ! gh auth status >/dev/null 2>&1; then \
		echo "‚ö†Ô∏è  GitHub CLI not authenticated"; \
		echo "   Run: gh auth login"; \
		exit 1; \
	fi
	@LAST_TAG=$$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0"); \
	LAST_NUM=$$(echo $$LAST_TAG | cut -d. -f3); \
	NEXT_NUM=$$(($$LAST_NUM + 1)); \
	NEXT_TAG=$$(echo $$LAST_TAG | sed "s/\\.$$LAST_NUM$$/.$${NEXT_NUM}/"); \
	echo "üìå Last tag: $$LAST_TAG"; \
	echo "üìå Next tag: $$NEXT_TAG"; \
	read -p "Use $$NEXT_TAG? [Y/n/custom]: " CONFIRM; \
	if [ -z "$$CONFIRM" ] || [ "$$CONFIRM" = "y" ] || [ "$$CONFIRM" = "Y" ]; then \
		VERSION=$$NEXT_TAG; \
	elif [ "$$CONFIRM" = "n" ] || [ "$$CONFIRM" = "N" ]; then \
		read -p "Enter version tag: " VERSION; \
	else \
		VERSION=$$CONFIRM; \
	fi; \
	if [ -z "$$VERSION" ]; then \
		echo "‚ùå Version required"; \
		exit 1; \
	fi; \
	echo "üì¶ Building for multiple platforms (parallel) with version $$VERSION..."; \
	mkdir -p $(DIST_DIR); \
	LDFLAGS="-X github.com/pocketbase/pocketbase/core.Version=$$VERSION"; \
	echo "  - darwin/arm64..." && ( cd $(BASE_DIR) && CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags "$$LDFLAGS" -o $(DIST_DIR)/wellknown-pb-darwin-arm64 . ) & \
	echo "  - darwin/amd64..." && ( cd $(BASE_DIR) && CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags "$$LDFLAGS" -o $(DIST_DIR)/wellknown-pb-darwin-amd64 . ) & \
	echo "  - linux/amd64..." && ( cd $(BASE_DIR) && CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "$$LDFLAGS" -o $(DIST_DIR)/wellknown-pb-linux-amd64 . ) & \
	echo "  - linux/arm64..." && ( cd $(BASE_DIR) && CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags "$$LDFLAGS" -o $(DIST_DIR)/wellknown-pb-linux-arm64 . ) & \
	echo "  - windows/amd64..." && ( cd $(BASE_DIR) && CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags "$$LDFLAGS" -o $(DIST_DIR)/wellknown-pb-windows-amd64.exe . ) & \
	echo "  - windows/arm64..." && ( cd $(BASE_DIR) && CGO_ENABLED=0 GOOS=windows GOARCH=arm64 go build -ldflags "$$LDFLAGS" -o $(DIST_DIR)/wellknown-pb-windows-arm64.exe . ) & \
	wait && \
	echo "‚úÖ All builds complete!" && \
	echo "üì¶ Creating ZIP archives for ghupdate..." && \
	cd $(DIST_DIR) && \
	cp wellknown-pb-darwin-arm64 wellknown-pb && zip wellknown-pb_darwin_arm64.zip wellknown-pb && rm wellknown-pb && \
	cp wellknown-pb-darwin-amd64 wellknown-pb && zip wellknown-pb_darwin_amd64.zip wellknown-pb && rm wellknown-pb && \
	cp wellknown-pb-linux-amd64 wellknown-pb && zip wellknown-pb_linux_amd64.zip wellknown-pb && rm wellknown-pb && \
	cp wellknown-pb-linux-arm64 wellknown-pb && zip wellknown-pb_linux_arm64.zip wellknown-pb && rm wellknown-pb && \
	cp wellknown-pb-windows-amd64.exe wellknown-pb.exe && zip wellknown-pb_windows_amd64.zip wellknown-pb.exe && rm wellknown-pb.exe && \
	cp wellknown-pb-windows-arm64.exe wellknown-pb.exe && zip wellknown-pb_windows_arm64.zip wellknown-pb.exe && rm wellknown-pb.exe && \
	cd $(PROJECT_ROOT) && \
	echo "üè∑Ô∏è  Creating git tag $$VERSION..." && \
	git tag -a "$$VERSION" -m "Release $$VERSION" && \
	git push origin "$$VERSION" && \
	echo "üìù Creating GitHub release $$VERSION..." && \
	gh release create "$$VERSION" $(DIST_DIR)/wellknown-pb*.zip \
		--title "PocketBase Server $$VERSION" \
		--notes "Release $$VERSION of wellknown PocketBase server" && \
	echo "" && \
	echo "‚úÖ Release $$VERSION created!" && \
	echo "üîó https://github.com/$(GH_OWNER)/$(GH_REPO)/releases/tag/$$VERSION" && \
	echo "‚¨áÔ∏è  Update: $(BINARY) update"

## update: Update binary from GitHub releases
update:
	@echo "‚¨áÔ∏è  Updating from GitHub releases..."
	@if [ ! -f $(BINARY) ]; then \
		echo "‚ùå Binary not found: $(BINARY)"; \
		echo "   Run: make build"; \
		exit 1; \
	fi
	$(BINARY) update
	@echo "‚úÖ Update complete!"

## version: Show current binary version
version:
	@echo "üìã PocketBase binary version:"
	@if [ ! -f $(BINARY) ]; then \
		echo "‚ùå Binary not found: $(BINARY)"; \
		echo "   Run: make build"; \
		exit 1; \
	fi
	@strings $(BINARY) | grep "github.com/pocketbase/pocketbase/core.Version=" | head -1 | sed 's/.*Version=/   /' | tr -d '"'
